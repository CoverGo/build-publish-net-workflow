# Build-publish workflow template for .Net backend projects on GitHubCI

CoverGo uses Github Actions as the main CI solution for building backend microservices. 
Github CI workflow is [generated by gflows tool](https://covergo.atlassian.net/wiki/spaces/BE/pages/134971667/How+to+connect+.Net+core+repository+to+CoverGo+Github+CI), using local settings from the repository and some templates from CoverGo repositories. 

# Workflow template structure

Workflow template is designed for a generic .Net microservice, with several assumptions: 

- There is one solution in the repository
- There is a main service docker image produced from the repository 
- The repository could contain several unit tests projects 
- The repository could contain several integration tests 
- For integration tests, we should build a docker-compose environment 
- The repository could contain a single NuGet package (for the microservice client, for example)

# Workflow usage

A workflow powers Github actions. The developer’s goal is to provide a valid workflow producing accurate results. The primary way to generate the workflow is to launch a gflow tool locally within a workflow template (this repo) and provide proper workflow settings. Gflows itself iconfigures by file [./gflows/config.yml](https://github.com/CoverGo/Auth/blob/master/.gflows/config.yml). You can find more information about config.yml at gflows official [documentation](https://github.com/jbrunton/gflows/wiki/Configuration). CoverGo provides a config.yml for all backend repositories, so you don’t need to create it, only change a workflow version if need. 

Each workflow is configured by a separate settings file, located at 
```./gflows/workflow-configuration/<workflow_name>/<workflow_name>.settings.yml ```

For build-publish workflow, this path is

` ./gflows/workflow-configuration/build-publish/build-publish.settings.yml `

# Workflow template development

 Build-publish workflow template repository supports generation of a sample workflow during template development. It has the [same gflows folder structure](https://github.com/CoverGo/build-publish-net-workflow/tree/main/.gflows) as any of its consumer repositories. You can run gflows CLI in a root folder of this repo, resulting in a [sample workflow](https://github.com/CoverGo/build-publish-net-workflow/tree/main/github-sample/workflows) generation for development purposes.
 
# Workflow template versions

All CoverGo workflows templates, powered by gflows, are versioned and use tags as version numbers. We can refer to a particular tag of a workflow to use or a branch. The recommended way is to refer tags to be protected from breaking changes introduced in the branches, like `/master`

The workflow version (tag) is used as a direct link to git-repo in the `templates/defaults/dependencies`  section of `config.yml`. In the example below build-publish workflow has [version `v1.10`](https://github.com/CoverGo/build-publish-net-workflow/releases/tag/v1.10).

```yml
# Config file for GFlows.
# See https://github.com/jbrunton/gflows/wiki/Configuration for options.
githubDir: .github
templates:
  engine: ytt
  defaults:
    libs: 
     - workflow-configuration
    dependencies:
      - https://raw.githubusercontent.com/CoverGo/ci-workflow-libraries/v1.2/.gflows
      - https://raw.githubusercontent.com/CoverGo/build-publish-net-workflow/v1.10/.gflows
      - https://raw.githubusercontent.com/CoverGo/workflow-check/v1.8/.gflows
      - https://raw.githubusercontent.com/CoverGo/deploy-tenant/v1.1/.gflows
      - https://raw.githubusercontent.com/CoverGo/scan-code-net/v1/.gflows

```

# Settings file structure

The Build-publish workflow template has a single settings file with several sections. In theory, it could be split into several files, but we need to check the exact behavior of gflows for such a case. [Example](https://github.com/CoverGo/build-publish-net-workflow/blob/main/.gflows/workflow-configuration/build-publish/settings.yml). 

Sections can come in any order in the file, except the YTT-specific header. Some sections are optional and could be omitted from the settings file. Some parts of the workflow will be skipped or generated with defaults in such a case. 

YTT-specific header (mandatory, must be in the header)
service (mandatory)
nuget (optional)
unit_test (optional, zero or more projects)
integration_test (optional, zero or more projects)
additional_images (optional, zero or more images)
cache_registry (mandatory)
main_registry (mandatory)
integration_tests_legacy (mandatory)
git (mandatory)

The following picture demonstrates how sections maps to workflow jobs in GitHub UI:
![Workflow with sections](https://user-images.githubusercontent.com/73324662/117607675-1672e400-b18f-11eb-9209-1e42e0749227.png)

The intended way of usage is to enable parts of the settings file throughout the repository development. 
If you have just the service, use a minimal version of the workflow. When we have unit tests added, a new section in the settings file is used, and so on. 

# Technical design

Build-publish workflow template is a central template for CoverGo .Net backend microservices, covering most of the needs to produce the images and packages. 
It uses some gflows packages for reused code and CoverGo-specific GitHub actions. More information [here](https://miro.com/app/board/o9J_lHoje38=/?moveToWidget=3074457357845402105&cot=14). 

