# Build-publish workflow for .Net backend projects on GitHubCI

CoverGo uses Github Actions as the main CI solution for building backend microservices. 
Github CI workflow is [generated by gflows tool](https://covergo.atlassian.net/wiki/spaces/BE/pages/134971667/How+to+connect+.Net+core+repository+to+CoverGo+Github+CI), using local settings from the repository and some templates from CoverGo repositories. 

# Workflow structure

Workflow is designed for a generic .Net microservice, with several assumptions: 

- There is one solution in the repository
- There is a main service docker image produced from the repository 
- The repository could contain several unit tests projects 
- The repository could contain several integration tests 
- For integration tests, we should build a docker-compose environment 
- The repository could contain a single NuGet package (for the microservice client, for example)

# Workflow usage

Workflow is used by Github actions, so the developer’s goal is to provide a valid workflow producing proper results. The main way for it is to launch gflow tool locally and provide proper workflow settings file to it. Gflows itself is configured by file [./gflows/config.yml](https://github.com/CoverGo/Auth/blob/master/.gflows/config.yml). You can find more information about config.yml at gflows oficcial [documentation](https://github.com/jbrunton/gflows/wiki/Configuration). CoverGo provides a config.yml for all backend repos, so you don’t need to create it, only change a workflwo version if need. 

Each workflow is configured by a separate settings file, located at 
```./gflows/workflow-configuration/<workflow_name>/<workflow_name>.settings.yml ```

For build-publish workflow this path is

` ./gflows/workflow-configuration/build-publish/build-publish.settings.yml `

# Workflow versions

All CoverGo workflows, powered by gflows, are versioned and use tags as version numbers. We can refer to a particular tag of a workflow to use, or a branch. The recommended way is to refer tags to be protected from breaking changes introduced in the branches, like `/master`. 

The workflow version (tag) is used as a direct link to git repo in `templates/defaults/dependencies`  section of `config.yml`  In the example below buil-publish workflow has version `v1.10`

```yml
# Config file for GFlows.
# See https://github.com/jbrunton/gflows/wiki/Configuration for options.
githubDir: .github
templates:
  engine: ytt
  defaults:
    libs: 
     - workflow-configuration
    dependencies:
      - https://raw.githubusercontent.com/CoverGo/ci-workflow-libraries/v1.2/.gflows
      - https://raw.githubusercontent.com/CoverGo/build-publish-net-workflow/v1.10/.gflows
      - https://raw.githubusercontent.com/CoverGo/workflow-check/v1.8/.gflows
      - https://raw.githubusercontent.com/CoverGo/deploy-tenant/v1.1/.gflows
      - https://raw.githubusercontent.com/CoverGo/scan-code-net/v1/.gflows

```

# Settings file structure

Build-publish workflow has a single settings file with several sections. In theory it could be splitted into several files, but need to check the exact behavior of gflows for such a case, just requires some efforts. 

Here is section list of settings files: 

```yml
#@data/values
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.all
---
#@overlay/match missing_ok=True
service:
  name:  Auth
  dockerfile: Dockerfile
  image_name: covergo/auth
  enabled: true
  slug: auth-service
  
nuget:
  name: Auth client nuget
  dockerfile: ./Nuget.Dockerfile
  container_result_path: app/nuget
  image_name: covergo/auth-nuget
  enabled: true
  slug: auth-nuget
  
unit_test:
  - name: Unit tests
    dockerfile: Tests.Unit.Dockerfile
    container_result_path: app/TestResults
    image_name: covergo/auth-test-unit
    enabled: true
    slug: auth-test-unit
  
integration_test:
  - name: Integration tests
    slug: auth-test-integration
    dockerfile: Tests.Integration.Dockerfile
    container_result_path: app/TestResults
    image_name: covergo/auth-test-integration
    enabled: true
    compose_file: docker-compose.yml
    compose_service_name: covergo-auth-tests-integration

additional_images:
  - name: Mongo db for all services
    dockerfile: Mongo.Dockerfile
    image_name: covergo/auth-mongo
    slug: auth-mongo
    
cache_registry:
  url: ghcr.io
  name: GitHub Container Registry
  user: ${{ github.repository_owner }}
  password: ${{ secrets.CR_PAT_FULL }}

main_registry:
  url: registry-intl.cn-hongkong.aliyuncs.com
  name: AliCloud Container Registry
  user: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
  password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}

integration_tests_legacy:
  runner: ubuntu-latest
  repository:
    url: covergo/integration-testing
    token: ${{ secrets.CR_PAT_FULL }}
    branch: master
  test_suites:
    small_tenants:
      name: Small tenants legacy integration tests 
      tests:
        - tahoe_uat
        - apex_uat
        - asia_uat
    big_tenants:
      name: Big tenants legacy integration tests
      tests:
        - test_uat
        - test_uat1
        - test_uat2
        - test_uat3
        - test_uat4
  environment:
    service_under_test:
      name: auth
      image: ghcr.io/covergo/auth:${{ needs.version.outputs.issue_id_slug }}
    mongo_user: root
    mongo_password: local_dev
    mongo_url: covergo-local-mongo:27017
 #   diagnostic_password: 123

git:
  branches:
    - master
    - main
    - f/*
    - F/*
    - r/*
    - R/*
    - b/*
    - B/*
 ```
