#@ load("@ytt:data", "data")
#@ load("@ytt:struct", "struct")
#@ load("tagging.lib.yml", "tagging")
#@ load("job_docker_publish_alicloud.lib.yml", "get_docker_publish_alicloud_job_ids")

---
#@ def generate_scan_image_job(scan_image, services):
  name: Trivy scan
  runs-on: ubuntu-latest
  timeout-minutes: 10
  needs: 
    - version
    #@ for alicloud_job_id in get_docker_publish_alicloud_job_ids(services):
    - #@ alicloud_job_id
    #@ end
  steps:
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: #@ scan_image.image
        format: 'table'
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
#@ end
---