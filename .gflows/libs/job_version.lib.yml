#@ load("@ytt:data", "data")
#@ load("@ytt:struct", "struct")
#@ load("tagging.lib.yml", "tagging")
#@ load("steps.lib.yml", "steps")
#@ load("common.lib.yml", "common")
---
#@ def set_version(context):
#@ if getattr(getattr(context,"versioning",None),"use_branch_slug", False):
#@ return "none"
#@ end
#@ return "${{ steps.issue-key.outputs.issue_id_slug }}"
#@ end
---
#@ def set_build_number(context):
#@ if getattr(getattr(context,"versioning",None),"use_build_number", False):
#@ return "${{ github.run_number }}"
#@ end
#@ return "none"
#@ end
---
#@ def generate_version_job(sections):
runs-on: ubuntu-latest
name: Get version from git tag
outputs:
  app_version: ${{ steps.version.outputs.app_version }}
  is_production: ${{ steps.is_production_check.outputs.is_production }}
  file_version: ${{ steps.version.outputs.file_version }}
  information_version: ${{ steps.version.outputs.information_version }}
  issue_id_slug: ${{ steps.issue-key.outputs.issue_id_slug }}
  docker_image_ali_cloud_tags: ${{ steps.tags.outputs.docker_image_ali_cloud_tags }}
  docker_image_ghcr_tags: ${{ steps.tags.outputs.docker_image_ghcr_tags }}
steps:
  - name: Checkout repository
    uses: actions/checkout@v3
    with:
      fetch-depth: 0
  - #@  steps.checkout_private_actions()
  - name: Get jira Ticket slug
    id: issue-key
    uses: ./.github/actions/get-issue-key
  - name: Get version from git tags
    id: version
    uses: ./.github/actions/get-version
    with:
      build-number: #@ set_build_number(sections)
      pre-release-version: #@ set_version(sections)
      production-branches: #@ "\n".join(getattr(getattr(sections,"versioning",None),"production_branches",["master","main"]))
  - name: Get docker image tags
    id: tags
    env:
      ghcr_versioned_tag: #@ tagging.with_registry(sections.cache_registry.url,sections.service.image_name,"${{ steps.version.outputs.app_version }}")
      ghcr_latest_tag: #@ tagging.with_registry(sections.cache_registry.url,sections.service.image_name,"latest")
      #@ if hasattr(sections,"main_registry"):
      ali_cloud_versioned_tag: #@ tagging.with_registry(sections.main_registry.url,sections.service.image_name,"${{ steps.version.outputs.app_version }}")
      ali_cloud_latest_tag: #@ tagging.with_registry(sections.main_registry.url,sections.service.image_name,"latest")
      #@ end
    run: |
      
      ali_cloud_tags=${ali_cloud_versioned_tag}
      ghcr_tags=${ghcr_versioned_tag}
      
      branch=$(git branch --show-current)
      if [[ "$branch" = 'main' || "$branch" = 'master'  ]]; then
        ali_cloud_tags="${ali_cloud_tags},${branch}"
        ghcr_tags="${ghcr_tags},${branch}"
      fi

      if [[ ${GITHUB_REF}  == refs/tags/v* ]]; then
        ali_cloud_tags="${ali_cloud_tags},${ali_cloud_latest_tag}"
        ghcr_tags="${ghcr_tags},${ghcr_latest_tag}"
      fi

      echo final tags for ghcr are:  ${ghcr_tags}
      echo final tags for ali are: ${ali_cloud_tags}
      echo ::set-output name=docker_image_ghcr_tags::${ghcr_tags}
      echo ::set-output name=docker_image_ali_cloud_tags::${ali_cloud_tags}
  - name: Is production check
    shell: bash
    id: is_production_check
    run: |
      if [[ ${{ steps.version.outputs.app_version }} =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo ::set-output name=is_production::true
      fi
#@ end
---